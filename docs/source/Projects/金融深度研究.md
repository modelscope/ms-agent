# 金融深度研究

Ms-Agent的 FinancialResearch 项目是一个面向金融市场研究场景的多智能体工作流，融合了定量金融数据分析能力与互联网舆情/资讯深度研究能力，自动生成结构化的专业研究报告。

## 原理介绍

### 特性

- **多智能体协同**：Orchestrator / Searcher / Collector / Analyst / Aggregator 五个专用智能体以 DAG 形式协同完成从任务拆解到报告聚合的全流程。
- **多维度研究**：同时覆盖“金融数据（定量）+ 舆情资讯（定性）”，结论更全面、更具解释性。
- **金融数据采集**：支持模型自动获取A股、港股、美股等市场的行情、财报、宏观指标与市场数据。
- **舆情深度研究**：复用深度研究工作流（`ms-agent/projects/deep_research`）开展新闻/媒体/社区等多源舆情分析。
- **安全可复现**：量化分析在 Docker 沙箱中执行，保证环境隔离与可复现性。
- **专业报告输出**：遵循 MECE、SWOT、金字塔原理等方法论，逐章生成并跨章节进行一致性校验。

### 架构

```text
                    ┌─────────────┐
                    │ Orchestrator│
                    │   Agent     │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
      ┌──────────────┐          ┌──────────────┐
      │   Searcher   │          │  Collector   │
      │    Agent     │          │    Agent     │
      └──────┬───────┘          └──────┬───────┘
             │                         │
             │                         ▼
             │                  ┌──────────────┐
             │                  │   Analyst    │
             │                  │    Agent     │
             │                  └──────┬───────┘
             │                         │
             └────────────┬────────────┘
                          ▼
                   ┌──────────────┐
                   │  Aggregator  │
                   │    Agent     │
                   └──────────────┘
```

- **Orchestrator**：拆解用户任务为任务与范围、金融数据任务、舆情研究任务三部分。
- **Searcher**：调用 `ms-agent/projects/deep_research` 执行舆情深度研究，输出舆情分析报告。
- **Collector**：按任务清单采集财报、宏观指标等金融数据，使用`FinancialDataFetcher`工具获取（基于akshare和baostock接口实现）。
- **Analyst**：在沙箱内执行定量分析，产出数据分析报告（带有可视化结果）。
- **Aggregator**：整合舆情分析与定量分析结果，逐章生成报告并进行一致性校验，最后合成综合研究报告。

## 使用方式

### Python环境

```bash
# 源码下载
git clone https://github.com/modelscope/ms-agent.git
cd ms-agent

# 依赖安装
conda create -n financial_research python=3.11
conda activate financial_research
# 从源码安装
pip install -r requirements/framework.txt
pip install -r requirements/research.txt
pip install -e .
# 从 PyPI 安装（>=v1.1.0）
pip install 'ms-agent[research]'
```

### 沙箱环境

```bash
pip install ms-enclave  # https://github.com/modelscope/ms-enclave
bash projects/financial_research/tools/build_jupyter_image.sh
```

### 环境变量

在系统环境或 YAML 中配置 API Key

```bash
# LLM API（系统环境配置示例）
export OPENAI_API_KEY=your_api_key
export OPENAI_BASE_URL=your-api-url

# 搜索引擎（用于舆情研究，可选 exa 或 serpapi）
export EXA_API_KEY=your_exa_api_key
export SERPAPI_API_KEY=your_serpapi_api_key
```

在 `searcher.yaml` 指定搜索引擎配置：

```yaml
tools:
  search_engine:
    config_file: projects/financial_research/conf.yaml
```

### 快速启动

```bash
# 在 ms-agent 根目录执行
PYTHONPATH=. python ms_agent/cli/cli.py run \
  --config projects/financial_research \
  --query '请分析宁德时代（300750.SZ）近四个季度盈利能力变化，并与新能源领域主要竞争对手进行对比；结合产业政策与锂价波动，预测其未来两季度趋势。' \
  --trust_remote_code true
```

## 开发指南

### 组件说明

- `workflow.yaml`：工作流配置入口，编排 Orchestrator / Searcher / Collector / Analyst / Aggregator 五个智能体的执行流程，基于DagWorkflow运行。
- `agent.yaml`（`orchestrator.yaml`、`searcher.yaml`、`collector.yaml`、`analyst.yaml`、`aggregator.yaml`）：定义各智能体（或者工作流）的行为、工具、LLM 参数和提示词（角色与职责）。
- `conf.yaml`：搜索引擎配置，包含 Exa / SerpAPI 等搜索工具的 API Key 与参数设置。
- `callbacks/`：各智能体专属的callback模块。
  - `orchestrator_callback.py`：保存任务规划到本地。
  - `collector_callback.py`：从本地加载任务规划并添加至用户消息。
  - `analyst_callback.py`：从本地加载任务规划并保存量化分析报告到本地。
  - `aggregator_callback.py`：保存最终综合分析报告到本地。
  - `file_parser.py`：代码/JSON文本的解析与处理。
- `tools/`：工具目录。
  - `build_jupyter_image.sh`：构建沙箱所需的 Docker 环境。
  - `principle_skill.py`：加载 MECE / SWOT / 金字塔原理等分析方法论。
  - `principles/`：报告生成所用方法论的 Markdown 文档。
- 其他关键模块：
  - `time_handler.py`：注入当前日期和时间到提示词中，避免出现幻觉。
  - `searcher.py`：调用深度研究项目进行舆情检索。
  - `aggregator.py`：聚合舆情与数据分析两类结果并生成最终报告。

### 使用示例

LLM 配置示例：

```yaml
llm:
  service: openai
  model: qwen3-max  # Analyst 可选 qwen3-coder-plus
  openai_api_key: ${OPENAI_API_KEY}
  openai_base_url: https://dashscope.aliyuncs.com/compatible-mode/v1
```

工具（沙箱）配置示例：

```yaml
tools:
  code_executor:
    sandbox:
      mode: local
      type: docker_notebook
      image: jupyter-kernel-gateway:version1
      timeout: 120
      memory_limit: "2g"
      cpu_limit: 2.0
      network_enabled: true
```

搜索配置（`searcher.yaml`）示例：

```yaml
breadth: 4  # 每层搜索生成的查询数
depth: 1    # 最大搜索深度
is_report: true  # 输出报告而非原始数据
```

### 输出结构

```text
output/
├── plan.json                           # 任务拆解结果
├── financial_data/                     # 金融数据
│   ├── stock_prices_*.csv
│   ├── quarterly_financials_*.csv
│   └── ...
├── sessions/                           # 分析会话制品（图表/指标）
├── memory/                             # 各智能体记忆
├── search/                             # 舆情搜索结果
├── resources/                          # 舆情图片
├── synthesized_findings.md             # 关键发现整合
├── report_outline.md                   # 报告结构
├── chapter_*.md                        # 各章节
├── cross_chapter_mismatches.md         # 跨章节一致性校验
├── analysis_report.md                  # 量化分析报告
├── report.md                           # 舆情分析报告
└── aggregator_report.md                # 最终综合报告
```

### 数据支持范围

受到数据接口限制，可能存在一定的缺失和错误，请注意甄别。

- **市场**：A股（sh./sz.）、港股（hk.）、美股（us.）
- **指数**：上证50、沪深300（HS300）、中证500（ZZ500）
- **数据类型**：K线、财报（利润/资产负债/现金流）、分红、行业分类
- **宏观**：利率、存款准备金率、货币供应量（中国）
