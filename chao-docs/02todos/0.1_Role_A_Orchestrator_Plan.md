# Role A: Orchestrator 实施计划 (System Architect)

**责任人**: A (fyc)
**目标**: 构建 "Research-to-Code" 全链路的指挥中枢，实现各模块的无侵入式调度与数据流转。
**依据**: [00comprehensive_integration_plan.md](../01goals/00comprehensive_integration_plan.md)

---

## 阶段 0: 架构定义与接口规范 (Day 1)
> **目标**: 确立项目骨架，定义与 Role B (Spec/Test) 和 Role C (Coding/Verify) 的交互契约。

- [x] **0.1 初始化编排器项目结构**
    - 创建目录结构：
      ```text
      orchestrator/
      ├── __init__.py
      ├── main.py             # CLI 入口
      ├── core/               # 核心逻辑
      │   ├── workspace.py    # 工作区管理
      │   ├── flow.py         # 流程控制
      │   └── config.py       # 配置管理
      ├── adapters/           # 适配器层 (对接各个Agent)
      │   ├── research_adapter.py
      │   └── ... (B/C 接口预留)
      └── utils/
      ```
- [x] **0.2 定义数据流转契约 (Markdown Templates)**
    - [x] 定义 `report.md` (Phase 1 Output) 的标准结构（与 Role B 确认）。
    - [x] 定义 `tech_spec.md` (Phase 2 Output) 的标准结构（与 Role B 确认）。
    - [x] 定义 `tests/` 目录的输出规范（与 Role C 确认）。
- [x] **0.3 编写配置管理模块**
    - [x] 实现 `orchestrator/core/config.py`，支持加载 `config.yaml` 或环境变量（用于配置 API Keys、模型参数、最大重试次数等）。

---

## 阶段 1: 核心编排器开发 (Day 2)
> **目标**: 实现 CLI 入口和工作区生命周期管理，确保“战场”有序。

- [x] **1.1 实现 Workspace Manager (`core/workspace.py`)**
    - [x] 功能：每次运行创建一个独立的时间戳目录 `workspace/run_YYYYMMDD_HHMMSS/`。
    - [x] 功能：提供 `get_path(filename)` 方法，统一管理文件路径，避免硬编码。
    - [x] 功能：初始化 `logs/orchestrator.log`，配置 Python `logging` 模块同时输出到控制台和文件。
- [x] **1.2 实现 CLI 入口 (`main.py`)**
    - [x] 使用 `argparse` 或 `click` 解析参数：
        - `--query`: 用户需求。
        - `--files`: (可选) 本地文件路径列表。
        - `--urls`: (可选) 待研读 URL 列表。
        - `--mode`: `research_only` | `full` (方便调试)。
    - [x] 实现基础的 `try-catch` 块，确保程序崩溃时能保存错误日志。

---

## 阶段 2: Research 模块适配 (Day 3)
> **目标**: “无侵入”地复用 `ms_agent` 现有的 Research 能力。

- [x] **2.1 深度分析 `doc_research` 源码**
    - [x] 阅读 `ms_agent/app/doc_research.py`，定位 `ResearchWorkflow` 及其依赖。
    - [x] 确认如何传入 `openai_api_key` 和 `model` 等配置而不依赖环境变量。
- [x] **2.2 实现 Doc Research 适配器 (`adapters/research_adapter.py`)**
    - [x] **类**: `DocResearchAdapter`
    - [x] **功能**: 接收文件路径列表，初始化 `ResearchWorkflow`，执行分析。
    - [x] **输出**: 将生成的 Markdown 报告保存为 `workspace/.../report.md`。
    - [x] **测试**: 编写单元测试 `tests/test_doc_adapter.py`，验证能否不启动 Gradio 直接生成报告。
- [x] **2.3 实现 Deep Research 适配器 (`adapters/research_adapter.py`)**
    - [x] **类**: `DeepResearchAdapter`
    - [x] **功能**: 封装 `projects/deep_research` 的调用（优先考虑 `subprocess` 调用以保证环境隔离，或直接 import `projects.deep_research.run` 里的核心逻辑）。
    - [x] **策略**: 统一 Deep 和 Doc 的输出接口，都产出 `report.md`。

---

## 阶段 3: 交互控制与流程串联 (Day 3-4)
> **目标**: 实现 Human-in-the-Loop (HITL) 机制，并串联 Role B 和 Role C 的工作。

- [x] **3.1 实现交互控制器 (`core/flow.py`)**
    - [x] **功能**: `InteractionManager.request_review(file_path)`。
    - [x] **逻辑**:
        1. 打印：“请检查并编辑生成的文档: [路径]”
        2. 暂停程序执行。
        3. 等待用户输入 "c" (continue) 或 "r" (reload)。
        4. 如果用户修改了文件，重新加载文件内容。
- [x] **3.2 集成 Spec Adapter (对接 Role B)**
    - [x] 在 `orchestrator.py` 中预留调用 Role B 代码的位置。
    - [x] 模拟输入：读取 `report.md`。
    - [x] 模拟输出：检查 `tech_spec.md` 是否生成。
- [x] **3.3 集成 Code Generator (对接 Role C)**
    - [x] 在 `orchestrator.py` 中预留调用 Role C 代码的位置。
    - [x] 传递参数：`tech_spec.md` 路径, `tests/` 路径。

---

## 阶段 4: 全链路联调与外循环 (Day 5)
> **目标**: 跑通 "User Query -> Research -> Spec -> Test -> Code -> Verify" 闭环。

- [x] **4.1 实现主流程逻辑 (`Orchestrator.run()`)**
    - [x] 串联：Input -> ResearchAdapter -> report.md
    - [x] 串联：report.md -> SpecAdapter (Role B) -> tech_spec.md
    - [x] **HITL**: 调用 `request_review('tech_spec.md')`
    - [x] 串联：tech_spec.md -> TestGen (Role B) -> tests/
    - [x] 串联：Meta-Prompt 构造 -> CodeAdapter (Role C) -> src/
- [x] **4.2 实现外循环重试机制 (Outer Loop)**
    - [x] 接收 Role C 返回的测试结果（Exit Code / Error Log）。
    - [x] 判断：如果失败且 `retry_count < MAX_RETRIES`，触发重试。
    - [x] 重试逻辑：将 Error Log 附加到 Prompt，再次调用 CodeAdapter。
- [x] **4.3 端到端演示验证**
    - [x] 准备测试用例：“基于提供的 PDF 论文，实现其中的核心算法 Demo”。
    - [x] 验证最终产出的代码能否通过预置测试。

---

## 依赖项
- 需要 Role B 提供 `SpecGenerator` 类/接口。
- 需要 Role C 提供 `CodeRunner` 类/接口及 `pytest` 封装。
