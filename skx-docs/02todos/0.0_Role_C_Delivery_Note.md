# Role C 交付文档: 外部工具集成与验证闭环

**日期**: 2025-11-27
**责任人**: Role C (Integration Engineer & Verification Loop)

## 1. 变更文件树 (File Tree of Changes)

本次开发构建了外部工具集成与验证系统，实现Deep Research与Code Scratch的黑盒调用、Prompt注入和外循环验证。严格遵循无侵入原则，不在任何原模块内部添加代码。

```text
.
├── orchestrator/
│   └── adapters/
│       ├── deep_research_adapter.py  # [MOD] 角色A提供基础，角色C完善
│       ├── code_adapter.py          # [MOD] 角色A提供基础，角色C完善
│       ├── spec_adapter.py          # [NEW] 角色B spec生成适配器
│       ├── test_gen_adapter.py      # [NEW] 角色B test生成适配器
│       └── doc_research_adapter.py  # [NEW] 角色A doc_research适配器
├── external_integration/              # [NEW] 角色C外部集成模块
│   ├── __init__.py
│   ├── deep_research_caller.py      # [NEW] Deep Research黑盒调用
│   ├── code_scratch_caller.py       # [NEW] Code Scratch黑盒调用
│   ├── prompt_injector.py           # [NEW] Prompt注入器
│   └── test_runner.py               # [NEW] 测试运行器与验证闭环
├── skx-docs/                        # [NEW] 角色C文档目录
│   ├── 00analysis/
│   │   ├── external_integration_analysis.md # 外部集成分析
│   │   └── verification_loop_design.md      # 验证闭环设计
│   ├── 01goals/
│   │   ├── role_c_goals.md          # 角色C目标
│   │   └── integration_with_role_a.md       # 与角色A集成计划
│   └── 02todos/
│       ├── 0.0_Role_C_Delivery_Note.md # 本交付文档
│       └── 0.1_Role_C_Integration_Plan.md # 集成实施计划
└── tests/
    └── test_external_integration.py # [NEW] 外部集成测试
```

## 2. 完成工作总结 (Summary of Work)

1.  **Deep Research 集成**: 实现了对 `projects/deep_research` 模块的黑盒调用封装，通过外部subprocess调用实现无侵入式集成。
2.  **Code Scratch 集成**: 实现了对 `projects/code_scratch` 模块的黑盒调用，通过外部subprocess调用实现无侵入式集成。
3.  **Prompt 注入机制**: 开发了 "元指令" (Meta-Instruction) 构造器，将技术规范和测试用例注入到代码生成流程中。
4.  **验证闭环系统**: 实现了自动化的 Pytest 执行、错误日志提取和修复反馈机制。
5.  **与 Orchestrator 集成**: 与 Role A 的适配器模式无缝集成，支持外循环重试机制。
6.  **适配器完善**: 完善了 Orchestrator 中的适配器实现，实现了完整的 AI Agent 工作流。

## 3. 使用指南 (User Guide)

### 3.1 环境准备

确保安装了项目依赖：

```bash
pip install -r requirements/framework.txt
pip install -r requirements/research.txt
pip install -r requirements/code.txt
```

设置必要的环境变量：

```bash
export OPENAI_API_KEY="sk-xxx"
export MODELSCOPE_API_KEY="ms-xxx"
export EXA_API_KEY="xxx"      # 用于 Deep Research
export SERPAPI_API_KEY="xxx"  # 作为 Exa 的备用搜索引擎
```

### 3.2 与 Orchestrator 集成使用

角色C的组件将通过Role A的orchestrator自动调用，无需单独启动，orchestrator会按以下流程调用：

1. Role A解析输入并决定调用模式
2. 如果需要Deep Research，调用Role C的deep_research_adapter
3. Role B处理技术规范和测试生成（通过spec_adapter和test_gen_adapter）
4. Role A将tech_spec.md和tests/传递给Role C的code_adapter
5. Role C执行Prompt注入并调用code_scratch
6. Role C运行验证器并返回结果
7. 如验证失败，根据反馈进行重试

### 3.3 独立使用

也可以独立使用验证闭环系统：

```bash
python3 -c "
from external_integration.test_runner import TestRunner
runner = TestRunner()
result = runner.run_tests_with_feedback('./workspace/run_XXXX/')
print(result)
"
```

### 3.4 配置说明

- 通过orchestrator的配置文件配置模型参数和重试次数
- 验证系统的配置也在orchestrator中统一管理
- Deep Research 中使用 ExaSearch 作为主要搜索工具，SerpApiSearch 作为备用，ArxivSearch 为默认选项

## 4. 与 Role A 的协同说明

- **输入接口**: 接收来自Role A编排器的query、tech_spec.md和tests/目录
- **输出接口**: 向编排器返回Deep Research结果或Code生成结果
- **错误处理**: 当Code验证失败时，提供详细的错误日志用于触发重试
- **适配器集成**: 增强Role A提供的适配器实现，提供完整的功能
- **工作流协调**: 与Role A、Role B协同，实现"Query -> Deep Research -> Spec/Test -> Code -> Verify -> Retry"的完整闭环
