# Role C: 外部工具集成与验证闭环实施计划 (Integration Engineer & Verification Loop)

**责任人**: C (skx)
**目标**: 实现对Deep Research和Code Scratch模块的黑盒调用、Prompt注入机制和外循环验证系统，并以最小化修改的方式与Role A的orchestrator集成
**依据**: [00comprehensive_integration_plan.md](../../chao-docs/01goals/00comprehensive_integration_plan.md)

---

## 阶段 0: 接口对接与依赖分析 (Day 1)
> **目标**: 与Role A定义接口契约，分析orchestrator适配器接口，分析Deep Research和Code Scratch模块的调用方式

- [ ] **0.1 分析orchestrator适配器接口**
    - [ ] 研究 `orchestrator/adapters/deep_research_adapter.py` 的Mock实现
    - [ ] 研究 `orchestrator/adapters/code_adapter.py` 的Mock实现
    - [ ] 确认接口方法签名和返回值格式
- [ ] **0.2 分析Deep Research模块调用方式**
    - [ ] 研究 `projects/deep_research` 的CLI接口
    - [ ] 分析其运行时依赖和配置要求
    - [ ] 确定如何传入query和获取输出
- [ ] **0.3 分析Code Scratch模块调用方式**
    - [ ] 研究 `projects/code_scratch` 的CLI接口
    - [ ] 分析其运行时依赖和工作目录要求
    - [ ] 确定如何传入技术规范和测试

---

## 阶段 1: 外部工具调用封装 (Day 2)
> **目标**: 实现对Deep Research和Code Scratch的黑盒调用封装

- [ ] **1.1 实现Deep Research调用器 (`external_integration/deep_research_caller.py`)**
    - [ ] **类**: `DeepResearchCaller`
    - [ ] **功能**: 通过subprocess调用 `projects/deep_research`，传入用户query
    - [ ] **输出**: 将生成的报告保存到指定的工作目录
- [ ] **1.2 实现Code Scratch调用器 (`external_integration/code_scratch_caller.py`)**
    - [ ] **类**: `CodeScratchCaller`
    - [ ] **功能**: 通过subprocess调用 `projects/code_scratch`，使用预设的spec和tests
    - [ ] **环境**: 确保在隔离环境中运行，不影响系统状态

---

## 阶段 2: Prompt 注入与验证系统开发 (Day 2-3)
> **目标**: 实现将技术规范和测试用例注入到代码生成流程的核心机制，以及验证闭环系统

- [ ] **2.1 实现Prompt注入器 (`external_integration/prompt_injector.py`)**
    - [ ] **类**: `PromptInjector`
    - [ ] **功能**: 读取 `tech_spec.md` 和 `tests/` 目录，构造"元指令"
    - [ ] **输出**: 构造的完整prompt，包含"请遵循tech_spec.md并使tests/中的测试通过"的指令
- [ ] **2.2 实现测试运行器 (`external_integration/test_runner.py`)**
    - [ ] **类**: `TestRunner`
    - [ ] **功能**: 在指定目录下运行 `pytest`，捕获输出和错误
    - [ ] **输出**: 测试结果、错误日志、覆盖率信息
- [ ] **2.3 实现错误分析与反馈机制**
    - [ ] 解析 `pytest` 的错误输出
    - [ ] 提取关键错误信息用于修复任务构造
    - [ ] 实现错误日志格式化功能

---

## 阶段 3: 最小化集成orchestrator (Day 4)
> **目标**: 以最小化修改的方式更新orchestrator适配器

- [ ] **3.1 更新Deep Research适配器**
    - [ ] 修改 `orchestrator/adapters/deep_research_adapter.py`
    - [ ] 保持现有类结构和接口
    - [ ] 将Mock实现替换为调用 `external_integration.DeepResearchCaller`
- [ ] **3.2 更新Code适配器**
    - [ ] 修改 `orchestrator/adapters/code_adapter.py`
    - [ ] 保持现有类结构和接口
    - [ ] 集成 `external_integration.PromptInjector`、`CodeScratchCaller`和`TestRunner`
    - [ ] 实现完整的从spec到code到验证的流程

---

## 阶段 4: 集成测试与优化 (Day 5)
> **目标**: 完成与整个系统的联调，确保"Query -> Deep Research -> Spec/Test -> Code -> Verify -> Retry"闭环

- [ ] **4.1 端到端功能验证**
    - [ ] 验证从用户查询到Deep Research结果的完整流程
    - [ ] 验证从Spec/Test到Code生成及验证的完整流程
    - [ ] 验证错误重试机制的有效性
- [ ] **4.2 性能与稳定性验证**
    - [ ] 测试大规模调用场景下的稳定性
    - [ ] 优化subprocess调用性能
- [ ] **4.3 文档和交付**
    - [ ] 编写集成使用指南
    - [ ] 准备与Role A的接口规范文档

---

## 依赖项
- 需要 Role A 提供的 orchestrator 框架及其适配器接口规范
- 需要 Role B 提供 `tech_spec.md` 和 `tests/` 标准格式
