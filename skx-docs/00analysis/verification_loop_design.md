# 验证闭环设计

**日期**: 2025-11-27
**作者**: Role C

## 1. 验证闭环概述

验证闭环是角色C的核心功能之一，负责确保生成的代码符合技术规范和测试要求。它通过自动运行测试、分析结果并反馈错误信息来实现代码的持续改进。

## 2. 验证闭环流程

### 2.1 验证阶段
验证闭环包含以下几个阶段：

1. **代码生成完成**:
   - Role C调用code_scratch完成代码生成
   - 生成的代码位于工作目录的src/子目录

2. **测试执行**:
   - 自动运行Role B生成的测试用例
   - 执行pytest验证代码功能

3. **结果分析**:
   - 分析测试输出（stdout/stderr）
   - 判断测试是否通过

4. **反馈决策**:
   - 如果通过，向orchestrator返回成功状态
   - 如果失败，提取错误信息，触发重试

### 2.2 验证闭环流程图
```
       +-------------------+
       |  Generated Code   |
       +-------------------+
                |
                v
       +-------------------+
       |  Run Pytest       |
       +-------------------+
                |
                v
       +-------------------+
       |  Analyze Output   |
       +-------------------+
                |
                v
          Pass/Fail?
                |
        +-------+-------+
        |               |
        v               v
   Success to      Extract Error
 Orchestrator      Info & Retry
```

## 3. 与 Orchestrator 集成

### 3.1 接口设计
验证系统需要与orchestrator进行交互：
- 输入：工作目录路径（包含生成的代码和测试）
- 输出：验证结果、错误日志、重试建议

### 3.2 反馈机制
当验证失败时，验证器需要向orchestrator反馈详细的信息，以便：
1. Role A的orchestrator可以触发重试机制
2. Role C可以根据错误日志重新构造提示并再次调用code_scratch

## 4. 技术实现

### 4.1 测试执行
- 使用subprocess调用pytest
- 捕获stdout和stderr输出
- 解析pytest的JSON或JUnit格式输出（如果可用）

### 4.2 错误解析
- 识别Python异常类型和位置
- 提取关键错误信息
- 过滤环境或配置相关的错误

### 4.3 重试触发
- 定义触发重试的错误类型
- 构造包含错误信息的修复提示
- 与orchestrator的外循环机制集成

## 5. 错误处理策略

### 5.1 错误分类
- 语法错误：代码无法解析或运行
- 逻辑错误：代码运行但结果不符合预期
- 测试错误：测试用例本身的错误

### 5.2 重试逻辑
- 基于错误类型决定重试方式
- 将错误信息整合到新的提示中
- 设置最大重试次数限制

## 6. 性能与监控

### 6.1 测试效率
- 优化测试执行速度
- 支持测试并行执行
- 只运行相关的测试用例

### 6.2 监控指标
- 测试执行时间
- 成功/失败率
- 平均重试次数
