# Role A 交付文档: 编排器架构与基础实现

**日期**: 2025-11-26
**责任人**: Role A (System Architect)

## 1. 变更文件树 (File Tree of Changes)

本次开发构建了全新的 `orchestrator` 模块，作为项目的指挥中枢，未修改 `ms_agent` 核心代码。

```text
.
├── orchestrator/                   # [NEW] 编排器核心目录
│   ├── __init__.py
│   ├── main.py                     # CLI 主入口 (支持参数解析与流程调度)
│   ├── core/
│   │   ├── config.py               # 配置管理 (Env/YAML)
│   │   ├── workspace.py            # 工作区生命周期管理 (run_YYYYMMDD...)
│   │   ├── flow.py                 # 交互流控制 (Human-in-the-Loop)
│   │   ├── const.py                # 系统常量定义
│   │   └── templates.py            # Report/Spec 标准模板定义
│   ├── adapters/                   # 适配器层 (连接各模块)
│   │   ├── base.py                 # 适配器抽象基类
│   │   ├── doc_research_adapter.py # 封装 Doc Research (ms_agent.app)
│   │   ├── deep_research_adapter.py# 封装 Deep Research (projects.deep_research)
│   │   ├── spec_adapter.py         # [Mock] Role B 接口 (Spec生成)
│   │   ├── test_gen_adapter.py     # [Mock] Role B 接口 (测试生成)
│   │   └── code_adapter.py         # [Mock] Role C 接口 (代码生成)
│   └── utils/
│       ├── logger.py               # 双路日志系统 (Console/File)
│       └── verifier.py             # 自动化测试运行器 (pytest封装)
├── scripts/
│   └── demo_orchestrator.sh        # [NEW] 一键演示脚本
└── chao-docs/02todos/              # [UPDATE] 任务追踪文档
```

## 2. 完成工作总结 (Summary of Work)

1.  **架构搭建**: 建立了基于适配器模式 (Adapter Pattern) 的编排器架构，实现了模块间的解耦。
2.  **Research 集成**: 成功封装了 `DocResearch` (本地文件分析) 和 `DeepResearch` (联网深度搜索) 模块，统一输出为 `report.md`。
3.  **数据契约定义**: 确立了 `Report -> Spec -> Test -> Code` 的数据流转标准。
4.  **外循环机制 (Outer Loop)**: 实现了 "Code -> Verify (Pytest) -> Retry" 的自动修复闭环逻辑。
5.  **Mock 占位**: 为 Role B (Spec/Test) 和 Role C (Code) 提供了 Mock 实现，确保在队友代码就位前，主流程可跑通。
6.  **交互控制**: 实现了 `wait_for_human_review`，支持用户在流程中间暂停并修改生成的 Spec 文档。

## 3. 使用指南 (User Guide)

### 3.1 环境准备

确保安装了项目依赖：

```bash
pip install -r requirements/framework.txt
```

设置必要的环境变量 (在 `.env` 文件或 export)：

```bash
export OPENAI_API_KEY="sk-xxx"
# export MODELSCOPE_API_KEY="xxx" # 如果使用 ModelScope
# export EXA_API_KEY="xxx"        # 可选：用于 Deep Research 增强搜索
```

### 3.2 快速演示 (Demo Script)

使用提供的脚本一键运行全流程（包含 Research -> Mock Spec -> Mock Code -> Mock Verify）：

```bash
# 给予执行权限
chmod +x scripts/demo_orchestrator.sh

# 运行 (默认 Query: "Help me build a snake game with Python")
./scripts/demo_orchestrator.sh

# 自定义 Query
./scripts/demo_orchestrator.sh "Analyze the current state of AI Agents"
```

### 3.3 CLI 详细用法

您也可以直接使用 Python 调用 CLI：

**场景 A: 纯网络研究 (Deep Research)**

```bash
python3 orchestrator/main.py "Recent advances in LLM reasoning" --mode research_only
```

**场景 B: 基于文档的研究 (Doc Research)**

```bash
python3 orchestrator/main.py "Summarize this paper" --files ./paper.pdf --mode research_only
```

**场景 C: 全流程生成 (Research -> Code)**

```bash
python3 orchestrator/main.py "Build a calculator based on this requirement doc" --files ./req.txt
```

_(注：目前 Phase 2-4 为 Mock 实现，仅生成占位文件)_

### 3.4 产出物位置

每次运行都会在 `workspace/` 目录下生成一个带时间戳的文件夹，结构如下：

```text
workspace/run_20251126_120000/
├── report.md         # Research 阶段产出
├── tech_spec.md      # Spec 阶段产出
├── tests/            # Test Gen 阶段产出
│   └── test_core.py
├── src/              # Coding 阶段产出
│   └── main.py
└── logs/
    └── orchestrator.log # 详细运行日志
```

## 4. 给 Role B & C 的交接说明

- **Role B (Spec/Test Agent)**:
  - 请修改 `orchestrator/adapters/spec_adapter.py`，接入真实的 Spec 生成 Agent。
  - 请修改 `orchestrator/adapters/test_gen_adapter.py`，接入真实的测试生成 Agent。
  - 输入/输出路径已在 `BaseAdapter` 中规范化。
- **Role C (Coding Agent)**:
  - 请修改 `orchestrator/adapters/code_adapter.py`，接入真实的 `Code Scratch` 或其他 Coding Agent。
  - 请利用 `error_log` 参数实现修复逻辑。
