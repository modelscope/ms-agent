# Phase 4: 全链路联调与外循环任务清单

**对应阶段**: Phase 4
**目标**: 将所有组件组装成完整的流水线，实现“外循环”重试机制，并进行端到端验证。

---

## 4.1 主流程编排 (`main.py` Update)
- [x] **实现 `run_pipeline()` 函数**
    - **Step 1: Research**
        - 调用 `DocResearchAdapter` 或 `DeepResearchAdapter`。
        - 产出 `workspace/.../report.md`。
    - **Step 2: Spec Generation**
        - 调用 `SpecAdapter` (Role B)。
        - 产出 `workspace/.../tech_spec.md`。
    - **Step 3: Human Review**
        - 调用 `FlowController.wait_for_human_review('tech_spec.md')`。
    - **Step 4: Test Generation**
        - 调用 `TestGenAdapter` (Role B)。
        - 产出 `workspace/.../tests/test_core.py`。
    - **Step 5: Coding (Outer Loop)**
        - 进入外循环重试逻辑。

## 4.2 外循环重试机制 (Outer Loop)
- [x] **实现 `OuterLoopController`**
    - **逻辑**:
        ```python
        retries = 0
        while retries < MAX_RETRIES:
            # 1. Generate Code
            CodeAdapter.run(spec, tests, error_log)

            # 2. Verify
            exit_code, stdout, stderr = run_pytest(workspace)

            if exit_code == 0:
                logger.info("Tests passed!")
                break
            else:
                retries += 1
                logger.warning(f"Tests failed. Retry {retries}/{MAX_RETRIES}")
                error_log = parse_error_log(stdout, stderr)
        ```
- [x] **实现 `run_pytest` 辅助函数**
    - 使用 `subprocess` 在工作区运行 `pytest`。
    - 确保环境变量正确设置。

## 4.3 错误处理与日志
- [x] **增强异常捕获**
    - 在每个 Step 增加 try-except，捕获 Adapter 抛出的异常。
    - 发生致命错误时，保存当前状态并优雅退出。
- [x] **Artifact 归档**
    - 运行结束后，生成 `summary.md`，汇总各阶段产出的文件路径。

## 4.4 端到端演示验证 (Demo)
- [x] **准备测试场景**
    - 场景 A: 输入一个简单的 Python 算法需求（如“计算斐波那契数列”），无需 Research，直接走 Spec -> Code。
    - 场景 B: 输入一个 URL（如某篇 Arxiv 论文），走 DocResearch -> Spec -> Code。
- [x] **编写 `scripts/demo_run.sh`**
    - 自动化运行上述场景，验证全流程是否跑通。

## 4.5 文档编写
- [ ] **更新 `README.md`**
    - 添加 Orchestrator 的使用说明。
    - 记录目录结构和关键配置项。
